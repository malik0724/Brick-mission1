<script>
const canvas = document.getElementById("c");
const ctx = canvas.getContext("2d");

let W,H,floorY;
let level=1,totalBalls=20;
let balls=[],bricks=[];
let aiming=false,firing=false;
let aimDX=0,aimDY=-1;

function resize(){
  W = canvas.width = innerWidth;
  H = canvas.height = innerHeight;
  floorY = H - 120;
}
resize(); addEventListener("resize",resize);

function spawn(){
  bricks=[]; balls=[]; firing=false;
  let cols=7,pad=6;
  let size=(W-pad*(cols+1))/cols;
  for(let r=0;r<5;r++){
    for(let c=0;c<cols;c++){
      if(Math.random()>0.35){
        bricks.push({
          x:pad+c*(size+pad),
          y:80+r*(size+pad),
          w:size,h:size,
          hp:level+r
        });
      }
    }
  }
}
spawn();

function updateAim(x,y){
  let dx=x-W/2, dy=y-floorY;
  if(dy>-20) dy=-20;
  let len=Math.hypot(dx,dy);
  aimDX=dx/len; aimDY=dy/len;
}

addEventListener("touchstart",e=>{
  if(firing)return;
  aiming=true;
  updateAim(e.touches[0].clientX,e.touches[0].clientY);
});
addEventListener("touchmove",e=>{
  if(aiming) updateAim(e.touches[0].clientX,e.touches[0].clientY);
});
addEventListener("touchend",()=>{
  if(!aiming||firing)return;
  aiming=false;
  fire();
});

function fire(){
  firing=true;
  for(let i=0;i<totalBalls;i++){
    setTimeout(()=>{
      balls.push({
        x:W/2,y:floorY,
        vx:aimDX*12,
        vy:aimDY*12,
        live:true
      });
    },i*60);
  }
}

function update(){
  balls.forEach(b=>{
    if(!b.live)return;
    b.x+=b.vx; b.y+=b.vy;
    if(b.x<5||b.x>W-5) b.vx*=-1;
    if(b.y<60) b.vy*=-1;
    if(b.y>floorY){ b.live=false; }

    bricks.forEach(br=>{
      if(b.x>br.x&&b.x<br.x+br.w&&b.y>br.y&&b.y<br.y+br.h){
        b.vy*=-1;
        br.hp--;
      }
    });
  });

  bricks=bricks.filter(b=>b.hp>0);

  if(firing && balls.length && balls.every(b=>!b.live)){
    balls=[]; firing=false;
    if(bricks.length===0){ level++; spawn(); }
  }
}

function draw(){
  ctx.clearRect(0,0,W,H);

  if(aiming&&!firing){
    ctx.setLineDash([6,12]);
    ctx.strokeStyle="#0ff";
    ctx.beginPath();
    ctx.moveTo(W/2,floorY);
    ctx.lineTo(W/2+aimDX*600,floorY+aimDY*600);
    ctx.stroke();
    ctx.setLineDash([]);
  }

  bricks.forEach(b=>{
    ctx.fillStyle="#0ff";
    ctx.fillRect(b.x,b.y,b.w,b.h);
    ctx.fillStyle="#000";
    ctx.font="bold 16px Arial";
    ctx.textAlign="center";
    ctx.fillText(b.hp,b.x+b.w/2,b.y+b.h/2+6);
  });

  ctx.fillStyle="#fff";
  balls.forEach(b=>{
    if(b.live){
      ctx.beginPath();
      ctx.arc(b.x,b.y,4,0,Math.PI*2);
      ctx.fill();
    }
  });
}

function loop(){
  update();
  draw();
  requestAnimationFrame(loop);
}
loop();
</script>
